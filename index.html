<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AIMless ‚Ä¢ P2P Chat (single file)</title>
<style>
  :root { --bg:#0b0b0f; --panel:#16161d; --ink:#eaeaf2; --muted:#a7a7b3; --accent:#9b5cff; --accent2:#b47dff; }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 10% 0%, #141421 0%, var(--bg) 60%);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:18px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:1000px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:var(--panel);border:1px solid #222231;border-radius:14px;padding:14px}
  h1{margin:0 0 8px;font-size:18px}
  h2{margin:0 0 10px;font-size:15px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);color:#0b0b0f;border:0;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--accent2)}
  .btn.secondary{background:#2a2a38;color:var(--ink);border:1px solid #333349}
  .btn.danger{background:#ff5757;color:#0b0b0f}
  textarea,input{width:100%;background:#0f0f16;color:var(--ink);border:1px solid #282838;border-radius:8px;padding:10px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#24243a;color:var(--ink);font-size:12px}
  .ok{background:#1d3d23;color:#7dff8b}.warn{background:#3d3d1d;color:#ffe57d}.bad{background:#3d1d1d;color:#ff7d7d}
  .chat{height:320px;overflow:auto;border:1px solid #242436;border-radius:10px;background:#0f0f16;padding:10px}
  .msg{margin:6px 0}
  .me .bubble{background:#7b61ff;color:#fff}
  .peer .bubble{background:#202437}
  .bubble{display:inline-block;padding:8px 12px;border-radius:14px;max-width:70%;word-wrap:break-word}
  .status{margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <!-- Signaling -->
  <div class="card">
    <h1>üó®Ô∏è AIMless ‚Äî P2P Chat</h1>
    <h2>1) Role</h2>
    <div class="row">
      <label><input type="radio" name="role" value="host" checked> Host</label>
      <label><input type="radio" name="role" value="peer"> Peer</label>
      <span id="pcState" class="pill">idle</span>
      <span id="iceState" class="pill">idle</span>
      <span id="dcState" class="pill">idle</span>
    </div>

    <h2>2) Signaling (copy/paste blob)</h2>
    <div class="row">
      <button id="btnCreate" class="btn">Create Offer/Answer</button>
      <button id="btnCopy" class="btn secondary">üìã Copy</button>
      <button id="btnReset" class="btn danger">Reset</button>
    </div>

    <label class="mono" style="margin-top:8px">Your description (Base64)</label>
    <textarea id="local" rows="6" class="mono" placeholder="Your Base64 blob will appear here‚Ä¶" readonly></textarea>

    <label class="mono" style="margin-top:8px">Peer description (Base64 / JSON / raw SDP)</label>
    <textarea id="remote" rows="6" class="mono" placeholder="Paste the other side‚Äôs blob here‚Ä¶"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="btnSetRemote" class="btn">Set Remote</button>
      <span id="status" class="status"></span>
    </div>
  </div>

  <!-- Chat -->
  <div class="card">
    <h2>3) Chat</h2>
    <div class="row">
      <input id="name" placeholder="Your name (optional)">
    </div>
    <div id="chat" class="chat"></div>
    <div class="row" style="margin-top:8px">
      <input id="msg" placeholder="Type a message‚Ä¶" disabled>
      <button id="send" class="btn" disabled>Send</button>
    </div>
  </div>
</div>

<script>
/* ---------- shorthands ---------- */
const $ = id => document.getElementById(id);
const roleInputs = document.querySelectorAll('input[name="role"]');

/* ---------- state ---------- */
let role = 'host';
let pc, dc;

/* ---------- config ---------- */
const rtcConfig = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "stun:stun1.l.google.com:19302" }
  ],
  iceCandidatePoolSize: 10
};

/* ---------- ui helpers ---------- */
function pill(el, text, cls=""){ el.textContent=text; el.className="pill "+cls; }
function setStatus(t,c){ $('status').textContent=t; $('status').style.color=c||""; }
function addMsg(name, text, mine=false){
  const div=document.createElement('div'); div.className='msg '+(mine?'me':'peer');
  const b=document.createElement('div'); b.className='bubble'; b.textContent=(name?name+': ':'')+text;
  div.appendChild(b); $('chat').appendChild(div); $('chat').scrollTop=$('chat').scrollHeight;
}
function enableChat(on){ $('msg').disabled=!on; $('send').disabled=!on; }

/* ---------- robust blob handling ---------- */
function pack(desc) {
  // RTCSessionDescriptionInit -> Base64
  const json = JSON.stringify(desc);
  return btoa(unescape(encodeURIComponent(json)));
}
function unpackBase64(b64) {
  const json = decodeURIComponent(escape(atob(b64)));
  return JSON.parse(json);
}
function looksLikeJson(s){ return /^\s*\{/.test(s.trim()); }
function looksLikeSdp(s){ return /^\s*v=0\s*/.test(s.trim()); }

/* ---------- peer connection ---------- */
function setupPC(){
  if(pc){ try{pc.close();}catch{} }
  pc = new RTCPeerConnection(rtcConfig);

  pc.onconnectionstatechange = () => {
    const s = pc.connectionState;
    pill($('pcState'), s, s==='connected'?'ok':(s==='failed'||s==='closed'?'bad':'warn'));
    if (s==='connected' || s==='completed') { enableChat(true); setStatus('PC connected ‚úì','#7dff8b'); }
    if (s==='disconnected'||s==='failed'||s==='closed') enableChat(false);
  };

  pc.oniceconnectionstatechange = () => {
    const s = pc.iceConnectionState;
    pill($('iceState'), s, (s==='connected'||s==='completed')?'ok':(s==='failed'?'bad':'warn'));
  };

  // Non-trickle-ish: dump Base64 localDescription after candidates settle briefly
  let gatherTimer=null;
  pc.onicecandidate = () => {
    if (gatherTimer) clearTimeout(gatherTimer);
    gatherTimer = setTimeout(() => {
      if (pc.localDescription) $('local').value = pack(pc.localDescription);
    }, 300);
  };

  if (role==='host') {
    dc = pc.createDataChannel('chat',{ordered:true});
    wireDC(dc);
  } else {
    pc.ondatachannel = (ev)=>{ dc = ev.channel; wireDC(dc); };
  }
}

function wireDC(channel){
  pill($('dcState'), 'connecting', 'warn');

  channel.onopen = ()=>{
    pill($('dcState'),'open','ok');
    enableChat(true);
    $('msg').focus();
    setStatus('DataChannel open ‚úì','#7dff8b');
  };

  channel.onclose = ()=>{
    pill($('dcState'),'closed','bad');
    enableChat(false);
    setStatus('Disconnected','#ff7d7d');
  };

  channel.onerror = (e)=>{
    pill($('dcState'),'error','bad');
    setStatus('DC error','orange');
    console.error('DataChannel error:', e);
  };

  channel.onmessage = (ev)=>{
    try{
      const {name,text}=JSON.parse(ev.data);
      addMsg(name||'Peer', text, false);
    }catch{
      addMsg('Peer', String(ev.data), false);
    }
  };
}

/* ---------- actions ---------- */
async function createLocal(){
  if(!pc) setupPC();
  if(role==='host'){
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    setStatus('Gathering ICE for offer‚Ä¶');
  } else {
    if (!pc.remoteDescription){ setStatus('Set remote offer first', '#ffe57d'); return; }
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    setStatus('Gathering ICE for answer‚Ä¶');
  }
}

async function setRemote(){
  try{
    const raw = $('remote').value.trim();
    if (!raw) { setStatus('Paste peer blob first', '#ffe57d'); return; }

    let desc;
    if (looksLikeJson(raw)) {
      // Proper JSON (sdp should include \r\n escapes)
      desc = JSON.parse(raw);
    } else if (/^[A-Za-z0-9+/=\s]+$/.test(raw) && !looksLikeSdp(raw)) {
      // Base64 (preferred)
      desc = unpackBase64(raw.replace(/\s+/g,''));
    } else if (looksLikeSdp(raw)) {
      // Raw SDP text pasted directly from some apps
      desc = { type: (role === 'host' ? 'answer' : 'offer'), sdp: raw };
    } else {
      throw new Error('Unrecognized blob format');
    }

    if(!pc) setupPC();
    await pc.setRemoteDescription(desc);
    setStatus(`Remote ${desc.type} set`);
  }catch(e){
    console.error(e);
    setStatus('Invalid blob (try Base64 or raw SDP)', '#ff7d7d');
  }
}

function send(){
  const text = $('msg').value.trim();
  if(!text) return;
  if(!dc || dc.readyState!=='open'){
    setStatus('Not connected (DC not open)', '#ffe57d');
    return;
  }
  const name = $('name').value.trim();
  dc.send(JSON.stringify({name, text}));
  addMsg(name||'Me', text, true);
  $('msg').value='';
}

function resetAll(){
  try{ dc&&dc.close(); }catch{} try{ pc&&pc.close(); }catch{}
  pc=null; dc=null;
  $('local').value=''; $('remote').value='';
  $('chat').innerHTML='';
  enableChat(false);
  pill($('pcState'),'idle'); pill($('iceState'),'idle'); pill($('dcState'),'idle');
  setStatus('reset');
}

/* ---------- wire up ---------- */
roleInputs.forEach(r=>r.addEventListener('change',()=>{ role=r.value; resetAll(); setupPC(); }));
$('btnCreate').onclick=createLocal;
$('btnSetRemote').onclick=setRemote;
$('btnCopy').onclick=async()=>{ 
  const t=$('local').value.trim(); if(!t){ setStatus('Nothing to copy','#ffe57d'); return; }
  try{ await navigator.clipboard.writeText(t); setStatus('Copied Base64 ‚úì','#7dff8b'); }catch{ setStatus('Copy failed','#ff7d7d'); }
};
$('btnReset').onclick=resetAll;
$('send').onclick=send;
$('msg').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

/* ---------- init ---------- */
setupPC();
enableChat(false);

// tip on file:// vs localhost
if (location.protocol === 'file:') {
  setStatus('Tip: use http://localhost or HTTPS (WebRTC may be restricted on file://)', '#ffe57d');
}
</script>
</body>
</html>
